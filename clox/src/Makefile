# -----------------------------------------------------------------------------
#  Makefile for clox (Crafting Interpreters - Part 3)
#  Most common commands:
#    make          → debug build + copy to ./clox
#    make debug    → debug build
#    make release  → optimized build
#    make run      → run debug build with example
#    make clean
# -----------------------------------------------------------------------------

CC       := gcc
CFLAGS   := -std=c11 -Wall -Wextra -pedantic
LDFLAGS  :=

# Debug flags (very useful during development)
DEBUG_FLAGS   := -g -O0 -DDEBUG_TRACE_EXECUTION -DDEBUG_PRINT_CODE -DDEBUG_STRESS_GC -DDEBUG_LOG_GC

# Release flags (fastest executable)
RELEASE_FLAGS := -O3 -DNDEBUG

# Directories
SRC_DIR   := .
BUILD_DIR := build
BIN_DIR   := .

# Find all .c files (except any you might want to exclude)
SOURCES   := $(wildcard $(SRC_DIR)/*.c)
OBJECTS   := $(SOURCES:$(SRC_DIR)/%.c=$(BUILD_DIR)/%.o)
DEPENDS   := $(OBJECTS:.o=.d)

# Final executable names
EXEC_DEBUG   := $(BIN_DIR)/clox-debug
EXEC_RELEASE := $(BIN_DIR)/clox

# Default target: debug build
.PHONY: all
all: debug

# -----------------------------------------------------------------------------
# Debug build
# -----------------------------------------------------------------------------
.PHONY: debug
debug: CFLAGS += $(DEBUG_FLAGS)
debug: $(EXEC_DEBUG)
	@ echo "→ Debug build ready: ./clox-debug"
	@ ln -sf clox-debug $(BIN_DIR)/clox   # Convenient symlink

$(EXEC_DEBUG): $(OBJECTS)
	$(CC) $(OBJECTS) -o $@ $(LDFLAGS)
	@ echo "Linked debug binary → $@"

# -----------------------------------------------------------------------------
# Release/optimized build
# -----------------------------------------------------------------------------
.PHONY: release
release: CFLAGS += $(RELEASE_FLAGS)
release: $(EXEC_RELEASE)
	@ echo "→ Release build ready: ./clox"

$(EXEC_RELEASE): $(OBJECTS)
	$(CC) $(OBJECTS) -o $@ $(LDFLAGS)
	@ echo "Linked release binary → $@"


# -----------------------------------------------------------------------------
# Generic rules
# -----------------------------------------------------------------------------
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c | $(BUILD_DIR)
	$(CC) $(CFLAGS) -MMD -MP -c $< -o $@

$(BUILD_DIR):
	mkdir -p $@

# Include dependency files (auto-generated by -MMD)
-include $(DEPENDS)

# -----------------------------------------------------------------------------
# Utilities
# -----------------------------------------------------------------------------
.PHONY: run
run: debug
	./clox

.PHONY: clean
clean:
	rm -rf $(BUILD_DIR) $(EXEC_DEBUG) $(EXEC_RELEASE) $(BIN_DIR)/clox

.PHONY: help
help:
	@echo "Available targets:"
	@echo "  make          → debug build + ./clox symlink"
	@echo "  make debug    → debug build with tracing"
	@echo "  make release  → optimized build"
	@echo "  make run      → build & run debug version"
	@echo "  make clean    → remove build artifacts"
	@echo "  make help     → show this help"

# -----------------------------------------------------------------------------
# Quick test file (optional - customize path)
# -----------------------------------------------------------------------------
.PHONY: test
test: debug
	@echo "Running a quick test file (edit path in Makefile if needed)"
	./clox ../test.lox   # ← change this path to your test scriptC=gcc
# CFLAGS=-std=c11 -Wall -Wextra -pedantic
# LDFLAGS=
#
# DEBUG_FLAGS=
#
# %.o: %.c
# 	$(CC) -c -o $@ $< $(CFLAGS)
#
#
# clox: *.o
# 	$(CC) -o clox *.o
